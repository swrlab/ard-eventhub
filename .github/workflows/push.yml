
name: ingest push


on:
  push:
    branches:
    - feature/*
    - dev/*
    - main


env:
  NODE_VERSION: 14.5
  IMAGE_NAME: ingest
  REGISTRY_DOMAIN: eu.gcr.io
  GCP_RUN_REGION: europe-west1
  GCP_RUN_MEMORY: 256Mi
  GCP_RUN_TIMEOUT: 60


jobs:
  test-node:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/setup-node@v2
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Checkout repo ğŸ‘€
      uses: actions/checkout@v2

    - name: Install yarn
      run: npm install -g yarn

    - name: Get yarn cache directory path
      id: yarn-cache-dir-path
      run: echo "::set-output name=dir::$(yarn cache dir)"

    - uses: actions/cache@v2
      with:
        path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
        key: ${{ runner.os }}-node-${{ hashFiles('**/yarn.lock') }}
        restore-keys: |
          ${{ runner.os }}-node-

    - name: Install Dependencies
      run: yarn

    - name: ğŸ” Write GCP Ingest key
      run: echo '${{ secrets.KEYS_INGEST }}' > ./keys/ingest.json

    - name: Run index
      run: yarn ingest:test


  docker:
    runs-on: ubuntu-latest
    needs: test-node
    environment: dev
    outputs:
      BRANCH: ${{ steps.push.outputs.BRANCH }}
      VERSION: ${{ steps.push.outputs.VERSION }}
      IMAGE_URI: ${{ steps.push.outputs.IMAGE_URI }}
    steps:
    - name: ğŸ‘€ Checkout repo
      uses: actions/checkout@v2
      
    - name: ğŸ”‘ Setup Google Cloud Auth
      uses: google-github-actions/setup-gcloud@master
      with:
        service_account_key: ${{ secrets.GCP_GITHUB_SERVICE_ACCOUNT_KEY }}
        export_default_credentials: true
        
    - name: ğŸ”‘ Login to Registry
      run: "gcloud auth configure-docker $REGISTRY_DOMAIN"

    - name: ğŸ” Write GCP Ingest key
      run: echo '${{ secrets.KEYS_INGEST }}' > ./keys/ingest.json

    - name: ğŸš§ Building docker image
      run: "docker build ./ --file ./Dockerfile.ingest -t image"

    - name: ğŸ· Tagging & Pushing docker
      id: push
      run: |
        # Strip git ref prefix from version
        BRANCH=$(echo "${{ github.ref }}" | sed -e 's,.*/\(.*\),\1,')

        # Strip "v" prefix from tag name
        [[ "${{ github.ref }}" == "refs/tags/"* ]] && BRANCH=$(echo $BRANCH | sed -e 's/^v//')

        # Add custom wrapper syntax
        VERSION=g${{ github.run_number }}-d$(date +%j)-$BRANCH-${{ github.actor }}-$GITHUB_SHA

        # Build
        IMAGE_URI=$REGISTRY_DOMAIN/${{ secrets.GCP_PROJECT_ID }}/$IMAGE_NAME:$VERSION

        # Push image to registry
        docker tag image $IMAGE_URI
        docker push $IMAGE_URI

        # Update vars
        echo "::set-output name=BRANCH::$BRANCH"
        echo "::set-output name=VERSION::$VERSION"
        echo "::set-output name=IMAGE_URI::$IMAGE_URI"

    - name: ğŸ‘‹ Logout
      run: "docker logout"

  cloud-run-dev:
    environment: dev
    needs: docker
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ”‘ Setup Google Cloud Auth
      uses: google-github-actions/setup-gcloud@master
      with:
        service_account_key: ${{ secrets.GCP_GITHUB_SERVICE_ACCOUNT_KEY }}
        export_default_credentials: true

    - name: ğŸ§ª Add gcloud beta
      run: "gcloud components install beta"

    - name: ğŸ  Set Cloud Run environment
      run: "gcloud config set run/platform managed"

    - name: ğŸ—º Set Cloud Run region
      run: "gcloud config set run/region $GCP_RUN_REGION"

    - name: ğŸš€ Deploy main revision
      run: |
        gcloud beta run deploy ard-eventhub-ingest-dev \
          --image ${{ needs.docker.outputs.IMAGE_URI }} \
          --project ${{ secrets.GCP_PROJECT_ID }} \
          --allow-unauthenticated \
          --timeout $GCP_RUN_TIMEOUT \
          --memory $GCP_RUN_MEMORY \
          --update-env-vars STAGE=DEV \
          --service-account ${{ secrets.GCP_SERVICE_ACCOUNT_INGEST }}

  cloud-run-prod:
    environment: prod
    if: "github.ref == 'refs/heads/main'"
    needs: docker
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ”‘ Setup Google Cloud Auth
      uses: google-github-actions/setup-gcloud@master
      with:
        service_account_key: ${{ secrets.GCP_GITHUB_SERVICE_ACCOUNT_KEY }}
        export_default_credentials: true

    - name: ğŸ§ª Add gcloud beta
      run: "gcloud components install beta"

    - name: ğŸ  Set Cloud Run environment
      run: "gcloud config set run/platform managed"

    - name: ğŸ—º Set Cloud Run region
      run: "gcloud config set run/region $GCP_RUN_REGION"

    - name: ğŸš€ Deploy main revision
      run: |
        gcloud beta run deploy ard-eventhub-ingest-prod \
          --image ${{ needs.docker.outputs.IMAGE_URI }} \
          --project ${{ secrets.GCP_PROJECT_ID }} \
          --allow-unauthenticated \
          --timeout $GCP_RUN_TIMEOUT \
          --memory $GCP_RUN_MEMORY \
          --update-env-vars STAGE=PROD \
          --service-account ${{ secrets.GCP_SERVICE_ACCOUNT_INGEST }}
